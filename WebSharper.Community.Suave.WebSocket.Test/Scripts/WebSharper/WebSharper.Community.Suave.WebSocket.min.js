(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;a=window;b=a.WebSharper=a.WebSharper||{};c=b.Community=b.Community||{};d=c.Suave=c.Suave||{};e=d.WebSocket=d.WebSocket||{};f=e.JsonEncoding=e.JsonEncoding||{};g=e.Async=e.Async||{};h=e.Endpoint=e.Endpoint||{};i=e.Client=e.Client||{};j=i.WebSocketServer=i.WebSocketServer||{};k=i.WithEncoding=i.WithEncoding||{};l=a.IntelliFactory;m=l&&l.Runtime;n=b&&b.Control;o=n&&n.MailboxProcessor;p=b&&b.Concurrency;q=b&&b.Operators;r=b&&b.Json;s=b&&b.Seq;f=e.JsonEncoding=m.Class({ClientProviderOrElse:function(t){return this.$==1?t:t;}},null,f);g.FoldAgent=function(t,u){return o.Start(function(v){function w(x){return p.Delay(function(){var y;y=v.Receive(null);return p.Bind(y,function(z){var A;A=u(x,z);return p.Bind(A,w);});});}return w(t);},null);};h.CreateRemote=function(t,u){return h.New(t,"",q.DefaultArg(u,new f({$:0})));};h.New=function(t,u,v){return{URI:t,Route:u,JsonEncoding:v};};j=i.WebSocketServer=m.Class({Post:function(t){var u;u=this.conn;(function(v){u.send(v);}(this.encode(t)));},get_Connection:function(){return this.conn;}},null,j);j.New=m.Ctor(function(t,u){this.conn=t;this.encode=u;},j);k.Connect=function(t,u,v,w){var x;x=new a.WebSocket(v.URI);return k.FromWebSocket(t,u,x,w,v.JsonEncoding);};k.ConnectStateful=function(t,u,v,w){var x;x=new a.WebSocket(v.URI);return k.FromWebSocketStateful(t,u,x,w,v.JsonEncoding);};k.FromWebSocket=function(t,u,v,w,x){var y,z,A,B;y=i.getEncoding(t,u,x);z=y[1];A=i.cacheSocket(v,z);B=new j.New(v,y[0]);return p.Delay(function(){var C;C=w(B);return p.Bind(C,function(D){var E;E=function(F,G){var H;H=A(D);v.onopen=function(){D({$:2});return F(B);};v.onclose=function(){return D({$:3});};v.onmessage=function(I){return D({$:0,$0:z(I)});};v.onerror=function(){D({$:1});return G(a.Error("Could not connect to the server."));};H?F(B):void 0;};return p.FromContinuations(function(F,G,H){return E.apply(null,[F,G,H]);});});});};k.FromWebSocketStateful=function(t,u,v,w,x){var y,z,A,B;y=i.getEncoding(t,u,x);z=y[1];A=i.cacheSocket(v,z);B=new j.New(v,y[0]);return p.Delay(function(){var C,D;C=w(B);D=function(E,F){var G,H;G=g.FoldAgent(E,function(I,J){return(F(I))(J);});H=function(I,J){var K;K=A(function(L){var M;M=G.mailbox.AddLast(L);G.resume();});v.onopen=function(){var L;L=G.mailbox.AddLast({$:2});G.resume();return I(B);};v.onclose=function(){var L;L=G.mailbox.AddLast({$:3});return G.resume();};v.onmessage=function(L){var M;M=G.mailbox.AddLast({$:0,$0:z(L)});return G.resume();};v.onerror=function(){var L;L=G.mailbox.AddLast({$:1});G.resume();return J(a.Error("Could not connect to the server."));};K?I(B):void 0;};return p.FromContinuations(function(I,J,K){return H.apply(null,[I,J,K]);});};return p.Bind(C,function(E){return D(E[0],E[1]);});});};i.getEncoding=function(t,u,v){var w,x,y;w=v.$==0?[function(z){return a.JSON.stringify(z);},(x=function(z){return a.JSON.parse(z);},function(z){return r.Activate(x(z));})]:[t,u];y=w[1];return[w[0],function(z){return y(z.data);}];};i.cacheSocket=function(t,u){var v,w;v=[];w=[false];t.onopen=function(){v.push({$:2});w[0]=true;};t.onclose=function(){return v.push({$:3});};t.onmessage=function(x){return v.push({$:0,$0:u(x)});};t.onerror=function(){return v.push({$:1});};return function(x){s.iter(x,v);return w[0];};};}());
