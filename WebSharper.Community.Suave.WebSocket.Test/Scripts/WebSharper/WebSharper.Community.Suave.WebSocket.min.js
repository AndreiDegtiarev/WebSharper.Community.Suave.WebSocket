(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;a=window;b=a.WebSharper=a.WebSharper||{};c=b.Community=b.Community||{};d=c.Suave=c.Suave||{};e=d.WebSocket=d.WebSocket||{};f=e.JsonEncoding=e.JsonEncoding||{};g=e.Async=e.Async||{};h=e.Endpoint=e.Endpoint||{};i=e.Client=e.Client||{};j=i.WebSocketServer=i.WebSocketServer||{};k=i.WithEncoding=i.WithEncoding||{};l=a.IntelliFactory;m=l&&l.Runtime;n=b&&b.Control;o=n&&n.MailboxProcessor;p=b&&b.Concurrency;q=b&&b.Operators;r=b&&b.Json;s=b&&b.Seq;f=e.JsonEncoding=m.Class({ClientProviderOrElse:function(t){return this.$==1?t:t;}},null,f);g.FoldAgent=function(t,u){return o.Start(function(v){function w(x){return p.Delay(function(){var y;y=v.Receive(null);return p.Bind(y,function(z){var A;A=u(x,z);return p.Bind(A,w);});});}return w(t);},null);};h.CreateRemote=function(t,u){return h.New(t,"",q.DefaultArg(u,new f({$:0})));};h.New=function(t,u,v){return{URI:t,Route:u,JsonEncoding:v};};j=i.WebSocketServer=m.Class({Post:function(t){this.conn.send(this.encode(t));},get_Connection:function(){return this.conn;}},null,j);j.New=m.Ctor(function(t,u){this.conn=t;this.encode=u;},j);k.Connect=function(t,u,v,w){var x,y,z;x=(y=v.URI,new a.WebSocket(y));z=v.JsonEncoding;return k.FromWebSocket(t,u,x,w,z);};k.ConnectStateful=function(t,u,v,w){var x,y,z;x=(y=v.URI,new a.WebSocket(y));z=v.JsonEncoding;return k.FromWebSocketStateful(t,u,x,w,z);};k.FromWebSocket=function(t,u,v,w,x){var y,z,A,B,C;y=i.getEncoding(t,u,x);z=y[0];A=y[1];B=i.cacheSocket(v,A);C=new j.New(v,z);return p.Delay(function(){var D;D=w(C);return p.Bind(D,function(E){var F;F=function(G,H){var I;I=B(E);v.onopen=function(){E({$:2});return G(C);};v.onclose=function(){return E({$:3});};v.onmessage=function(J){return E({$:0,$0:A(J)});};v.onerror=function(){E({$:1});return H(a.Error("Could not connect to the server."));};I?G(C):void 0;};return p.FromContinuations(function(G,H,I){return F.apply(null,[G,H,I]);});});});};k.FromWebSocketStateful=function(t,u,v,w,x){var y,z,A,B,C;y=i.getEncoding(t,u,x);z=y[0];A=y[1];B=i.cacheSocket(v,A);C=new j.New(v,z);return p.Delay(function(){var D,E;D=w(C);E=function(F,G){var H,I;H=g.FoldAgent(F,function(J,K){return(G(J))(K);});I=function(J,K){var L;L=B(function(M){var N;N=H.mailbox.AddLast(M);H.resume();});v.onopen=function(){var M;M=H.mailbox.AddLast({$:2});H.resume();return J(C);};v.onclose=function(){var M;M=H.mailbox.AddLast({$:3});return H.resume();};v.onmessage=function(M){var N;N=H.mailbox.AddLast({$:0,$0:A(M)});return H.resume();};v.onerror=function(){var M;M=H.mailbox.AddLast({$:1});H.resume();return K(a.Error("Could not connect to the server."));};L?J(C):void 0;};return p.FromContinuations(function(J,K,L){return I.apply(null,[J,K,L]);});};return p.Bind(D,function(F){return E(F[0],F[1]);});});};i.getEncoding=function(t,u,v){var w,x,y,z;w=v.$==0?[function(A){return a.JSON.stringify(A);},(x=function(A){return a.JSON.parse(A);},function(A){return r.Activate(x(A));})]:[t,u];y=w[0];z=w[1];return[y,function(A){return z(A.data);}];};i.cacheSocket=function(t,u){var v,w;v=[];w=[false];t.onopen=function(){v.push({$:2});w[0]=true;};t.onclose=function(){return v.push({$:3});};t.onmessage=function(x){return v.push({$:0,$0:u(x)});};t.onerror=function(){return v.push({$:1});};return function(x){s.iter(x,v);return w[0];};};}());
